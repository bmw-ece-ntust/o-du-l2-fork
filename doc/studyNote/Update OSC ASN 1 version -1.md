# Update OSC ASN.1 version -1

Start Date: 2024/06/20
Summary: Upgrading the OSC ASN.1 source file to version 17 for improved interoperability testing and resolving encoding issues with the SIB1 data.
Status: Done
Assign: Ming å’šå’š [éŠ˜é´»]
Tags: OSC Integration problem

<aside>
ðŸ’¡ OSC original verison: **rrc_15_3_asn.asn1**

</aside>

<aside>
ðŸ’¡ OAI version: **nr-rrc-17.3.0.asn1**

</aside>

```c
/*
 * Generated by asn1c-0.9.29 (http://lionet.info/asn1c)
 * From ASN.1 module "NR-RRC-Definitions"
 * 	found in "../ASN1_Input/rrc_15_3_asn.asn1"
 * 	`asn1c -D ../RRC_output_14Nov/ -fcompound-names -fno-include-deps -findirect-choice -gen-PER`
 */
```

```c
/*
 * Generated by asn1c-0.9.29 (http://lionet.info/asn1c)
 * From ASN.1 module "NR-RRC-Definitions"
 * 	found in "/home/hpe/mwnl-odu-at-oai-based-on-scf/ASN.1/nr-rrc-17.3.0.asn1"
 * 	`asn1c -pdu=all -fcompound-names -gen-UPER -no-gen-BER -no-gen-JER -no-gen-OER -gen-APER -no-gen-example -findirect-choice -D /home/hpe/mwnl-odu-at-oai-based-on-scf/l2/src/codec_utils/RRC/`
 */
```

When we need to encode the SIB1 data into ASN.1 in OSC and then send it out via nFAPI, the current version of OSC fails to encode searchSpace->searchSpaceType. However, this is a required parameter. The OSC source code also mentions that this is an unresolved issue.

```c
/* Commented due to ASN decode failure in wireshark.
 * Parameters like dci_Format0_0_AndFormat1_0 which are pointer to a structure that 
 * does not have any member parameter lead to decode failure in wireshark. 
 * The issue has been reported to Nokia.
 * The following code will be uncommented once the issue is resolved */
```

However, the progress is currently stalled at this point. After comparison, even though both OSC and OAI use the same version of the ASN.1 compiler, OSC uses rel.15 for the build source file, while OAI uses rel.17. Additionally, local unit tests for OSC indicate that encoding with rel.15â€¦

```c
  encRetVal = uper_encode(&asn_DEF_BCCH_DL_SCH_Message, 0, &bcchMsg, PrepFinalEncBuf,\
        encBuf);
  printf("\nencbufSize: %d\n", encBufSize);
  if(encRetVal.encoded == -1)
  {
     DU_LOG("\nERROR  -->  DU APP : Could not encode BCCH-DL-SCH structure (at %s)\n",\
           encRetVal.failed_type ?
           encRetVal.failed_type->name :
           "unknown");
     break;
  }
  printf("\n[NTUST] Unit test decode\n");

  BCCH_DL_SCH_Message_t *bcch_message = NULL;
  asn_dec_rval_t rval = uper_decode(NULL, &asn_DEF_BCCH_DL_SCH_Message, &bcch_message, encBuf, encBufSize, 0, 0);
  if(rval.code == RC_FAIL || rval.code == RC_WMORE)
  {
     DU_LOG("\nERROR  -->  F1AP : ASN decode failed");
     return RFAILED;
  }
  xer_fprint(stdout, &asn_DEF_BCCH_DL_SCH_Message, bcch_message);
  printf("\n\n\n\n");
```

Decoding is not an issue; hence, it can be inferred that independent operation with the same version is problem-free. The different versions might cause encoding and decoding issues. Consequently, I have decided to upgrade the OSC ASN.1 source file to rel.17 for interoperability testing.

If you need to upgrade the version, you first need to obtain the source file from OAI:

[nr-rrc-17.3.0.asn1](nr-rrc-17.3.0.asn1)

Next, you need to install the ans.1 compiler. You will encounter a problem here and cannot compile the `-gen-UPER` parameter.

The reason is that the official version: Lev Walkin â†’ [Lev Walkin â†’ ASN.1 Exposed (lionet.info)](http://lionet.info/asn1c/blog/)  does not actually support this compilation parameter. You can learn from -help:

```c
  -no-gen-OER           Do not generate the OER (X.696) support code
  -no-gen-PER           Do not generate the PER (X.691) support code
  -no-gen-example       Do not generate the ASN.1 format converter example
  -gen-autotools        Generate example top-level configure.ac and Makefile.am
  -pdu={all|auto|Type}  Generate PDU table (discover PDUs automatically)
```

Therefore, if you go to the Trace OAI CMake file, you can find that OAI actually installs another source (the asn.1 compiler that has been forked and added new functions):

```bash
    # GIT_SSL_NO_VERIFY=true git clone https://gitlab.eurecom.fr/oai/asn1c.git /tmp/asn1c
    git clone https://github.com/mouse07410/asn1c /tmp/asn1c
    cd /tmp/asn1c
    git checkout vlm_master
    # Showing which version is used
    git log -n1
    autoreconf -iv
    ./configure --prefix /opt/asn1c/
    make -j`nproc`
    $SUDO make install
```

OAI use fork release:

[https://github.com/mouse07410/asn1c](https://github.com/mouse07410/asn1c)

OSC use fork release:

[https://github.com/nokia/asn1c](https://github.com/nokia/asn1c)

It will be automatically installed in the OAI script under the /opt/asn1c/bin path. You can find that its support is much higher:

```c
  -no-gen-BER           Do not generate the Basic Encoding Rules (BER, X.690) support code
  -no-gen-XER           Do not generate the XML Encoding Rules (XER, X.693) support code
  -no-gen-JER           Do not generate the JSON Encoding Rules (JER, X.697) support code
  -no-gen-OER           Do not generate the Octet Encoding Rules (OER, X.696) support code
  -no-gen-UPER          Do not generate the Unaligned Packed Encoding Rules (PER, X.691) support code
  -no-gen-APER          Do not generate the Aligned Packed Encoding Rules (PER, X.691) support code
  -no-gen-print         Do not generate the print code
  -no-gen-random-fill   Do not generate the random fill code
  -no-gen-example       Do not generate the ASN.1 format converter example
  -gen-autotools        Generate example top-level configure.ac and Makefile.am
  -pdu={all|auto|Type}  Generate PDU table (discover PDUs automatically)
```

Complete support:

```c
@awa:/opt/asn1c/bin$ ./asn1c --help
./asn1c: invalid option -- '-'
ASN.1 Compiler, v0.9.29
Copyright (c) 2003-2017 Lev Walkin <vlm@lionet.info> and contributors.
Usage: asn1c [options] file ...
Options:
  -E                    Run only the ASN.1 parser and print out the tree
  -F                    During -E operation, also perform tree fixing

  -P                    Concatenate and print the compiled text
  -R                    Restrict output (tables only, no support code)
  -S <dir>              Directory with support (skeleton?) files
                        (Default is "/opt/asn1c/share/asn1c")
  -D <dir>              Destination directory for generated files (default current dir)
  -X                    Generate and print the XML DTD

  -Werror               Treat warnings as errors; abort if any warning
  -Wdebug-lexer         Enable verbose debugging output from lexer
  -Wdebug-parser        Enable verbose debugging output from parser
  -Wdebug-fixer         --//-- semantics processor
  -Wdebug-compiler      --//-- compiler

  -fbless-SIZE          Allow SIZE() constraint for INTEGER etc (non-std.)
  -fcompound-names      Disambiguate C's struct NAME's inside top-level types
  -findirect-choice     Compile members of CHOICE as indirect pointers
  -fincludes-quoted     Generate #includes in "double" instead of <angle> quotes
  -fknown-extern-type=<name>    Pretend the specified type is known
  -fline-refs           Include ASN.1 module's line numbers in comments
  -fno-constraints      Do not generate the constraint checking code
  -fno-include-deps     Do not generate the courtesy #includes for dependencies
  -funnamed-unions      Enable unnamed unions in structures
  -fwide-types          Use INTEGER_t instead of "long" by default, etc.
  -fprefix=<prefix>     Add the specified prefix to generated types

  -no-gen-BER           Do not generate the Basic Encoding Rules (BER, X.690) support code
  -no-gen-XER           Do not generate the XML Encoding Rules (XER, X.693) support code
  -no-gen-JER           Do not generate the JSON Encoding Rules (JER, X.697) support code
  -no-gen-OER           Do not generate the Octet Encoding Rules (OER, X.696) support code
  -no-gen-UPER          Do not generate the Unaligned Packed Encoding Rules (PER, X.691) support code
  -no-gen-APER          Do not generate the Aligned Packed Encoding Rules (PER, X.691) support code
  -no-gen-print         Do not generate the print code
  -no-gen-random-fill   Do not generate the random fill code
  -no-gen-example       Do not generate the ASN.1 format converter example
  -gen-autotools        Generate example top-level configure.ac and Makefile.am
  -pdu={all|auto|Type}  Generate PDU table (discover PDUs automatically)

  -print-class-matrix   Print out the collected object class matrix (debug)
  -print-constraints    Explain subtype constraints (debug)
  -print-lines          Generate "-- #line" comments in -E output
```

Finally, execute this command to build a new version of asn.1 upper_encode struct based on the latest version of the source file.

```bash
sudo rm /home/hpe/mwnl-odu-at-oai-based-on-scf/l2/src/codec_utils/RRC/*

cd /tmp/asn1c/asn1c
sudo ./asn1c -pdu=all -fcompound-names -gen-UPER -no-gen-BER -no-gen-JER -no-gen-OER -gen-APER -no-gen-example -findirect-choice -D /home/hpe/mwnl-odu-at-oai-based-on-scf/l2/src/codec_utils/RRC/ /home/hpe/mwnl-odu-at-oai-based-on-scf/ASN.1/nr-rrc-17.3.0.asn1
sudo ./asn1c -pdu=all -fcompound-names -fno-include-deps -findirect-choice -gen-UPER -gen-JER -no-gen-BER -no-gen-JER -no-gen-OER -gen-APER -no-gen-example -D /home/hpe/mwnl-odu-at-oai-based-on-scf/l2/src/codec_utils/RRC/ /home/hpe/mwnl-odu-at-oai-based-on-scf/ASN.1/nr-rrc-17.3.0.asn1
sudo /tmp/asn1c/asn1c/asn1c -pdu=all -fcompound-names -fno-include-deps -findirect-choice -gen-UPER -gen-BER -gen-XER -no-gen-JER -no-gen-print -gen-OER -gen-APER -no-gen-example -D /home/hpe/mwnl-odu-at-oai-based-on-scf/l2/src/codec_utils/RRC/ /home/hpe/openairinterface5g/openair2/RRC/NR/MESSAGES/ASN.1/nr-rrc-15.3.0.asn1
```

<aside>
ðŸ’¡ OSC cannot be upgraded and OAI cannot be downgraded.

</aside>

After testing, it was found that OSC can rebuild new versions of .c and .h files using the ASN.1 compiler based on the source file. However, after updating OSC, it cannot read .h files at the same level, meaning typedefs and declarations in the header files cannot reference each other. The following checks were performed:

- OSC RRC related Makefile settings with the -I include path (pointing to the Common folder)
- The .c and .h files generated by the ASN.1 build process are read-only and cannot be modified
- Compared OAI's CMakeLists
- Verified that the file paths in the #include statements within the C files are correct

Due to these issues, it was decided to downgrade the OAI version from 17 to 15. However, although the location for setting the OAI version was found, directly downgrading still resulted in severe compilation issues.

Initially, only two versions were listed: 17 and 16

- Attempted to manually add version 15 and modify to 15 â†’ failed to compile
- Attempted to downgrade to version 16.4.1 â†’ failed to compile

Therefore, the following actions were taken:

1. Revisited the Makefile settings to ensure correct paths and dependencies.
2. Checked if the read-only attribute of the .c and .h files could be altered to allow modifications.
3. Examined whether any additional configurations in OAI's CMakeLists could be adapted for OSC.
4. Ensured that all necessary include paths and libraries were correctly specified and accessible during the build process.

After these steps, it was decided to:

1. Identify any specific dependency changes between rel.15 and rel.17 that might impact compilation.
2. Create a detailed comparison of the build processes and dependencies between the successful rel.17 and the failed rel.15 attempts.
3. Reach out to the community or maintainers of OSC and OAI for insights or patches that could address these compatibility issues.

```
set(NR_RRC_VERSION 17 3 0)
make_version(NR_RRC_cc ${NR_RRC_VERSION})
string(REPLACE ";" "." NR_RRC_RELEASE "${NR_RRC_VERSION}")

if(NR_RRC_RELEASE VERSION_EQUAL "16.4.1")
  include(ASN.1/nr-rrc-16.4.1.cmake)
elseif(NR_RRC_RELEASE VERSION_EQUAL "17.3.0")
  include(ASN.1/nr-rrc-17.3.0.cmake)
else()
  message(FATAL_ERROR "unknown NR_RRC_RELEASE ${NR_RRC_RELEASE}")
endif()
```

<aside>
ðŸ’¡ Summary: After successful OSC unit test, it can be determined that the same version (17 or 15) can be encoded and decoded by itself without any problems.

</aside>

Currently OSC 15 encode â†’ OAI 17 decode will fail to decode:

```
 å…­  21 22:51:54                                             </nrofCandidates>
 å…­  21 22:51:54                                             <searchSpaceType>
 å…­  21 22:51:54                                                 <common>
 å…­  21 22:51:54                                                     <dci-Format0-0-AndFormat1-0>
 å…­  21 22:51:54                                                     </dci-Format0-0-AndFormat1-0>
 å…­  21 22:51:54                                                 </common>
 å…­  21 22:51:54                                             </searchSpaceType>
 å…­  21 22:51:54                                         </SearchSpace>
 å…­  21 22:51:54                                     </commonSearchSpaceList>
 å…­  21 22:51:54                                     <searchSpaceSIB1>0</searchSpaceSIB1>
 å…­  21 22:51:54                                     <pagingSearchSpace>2</pagingSearchSpace>
 å…­  21 22:51:54                                     <ra-SearchSpace>3</ra-SearchSpace>
 å…­  21 22:51:54                                 </setup>
 å…­  21 22:51:54                             </pdcch-ConfigCommon>
 å…­  21 22:51:54                             <pdsch-ConfigCommon>
 å…­  21 22:51:54                                 <release></release>
 å…­  21 22:51:54                             </pdsch-ConfigCommon>
 å…­  21 22:51:54                         </initialDownlinkBWP>
 å…­  21 22:51:54                         <bcch-Config>
 å…­  21 22:51:54                             <modificationPeriodCoeff><n2/></modificationPeriodCoeff>
 å…­  21 22:51:54                         </bcch-Config>
 å…­  21 22:51:54                         <pcch-Config>
 å…­  21 22:51:54                             <defaultPagingCycle><rf32/></defaultPagingCycle>
```

Currently trying to manually and gradually modify the OAI small-scale asn_DEF_NR_BCCH_DL_SCH_Message structure to make the two versions the same (based on OSC version 15). After Trace, only modify all files used by encode SIB1

<aside>
ðŸ’¡ Try to modify the OAI CMake file and build through OSC

</aside>

```bash
sudo rm -r /home/hpe/openairinterface5g/cmake_targets/ran_build/build/openair2/RRC/NR/MESSAGES
sudo asn1c -pdu=all -fcompound-names -fno-include-deps -findirect-choice -gen-PER -D /home/hpe/openairinterface5g/cmake_targets/ran_build/build/openair2/RRC/NR/MESSAGES /home/hpe/openairinterface5g/openair2/RRC/NR/MESSAGES/ASN.1/nr-rrc-15.3.0.asn1
```

<aside>
ðŸ’¡ First determine whether OSC is executable based on OAI's ASN1 source file built with the old version.

</aside>

```bash
sudo rm /home/hpe/mwnl-odu-at-oai-based-on-scf/l2/src/codec_utils/RRC/*
sudo asn1c -pdu=all -fcompound-names -fno-include-deps -findirect-choice -gen-PER -D /home/hpe/mwnl-odu-at-oai-based-on-scf/l2/src/codec_utils/RRC/ /home/hpe/openairinterface5g/openair2/RRC/NR/MESSAGES/ASN.1/nr-rrc-15.3.0.asn1
/*Install OAI ASN.1 compile*/
/home/hpe/mwnl-odu-at-oai-based-on-scf/l2/src/codec_utils/RRC
sudo ./asn1c -pdu=all -fcompound-names -gen-UPER -no-gen-BER -no-gen-JER -no-gen-OER -gen-APER -no-gen-example -findirect-choice -D ./temp /home/hpe/openairinterface5g/openair2/RRC/NR/MESSAGES/ASN.1/nr-rrc-17.3.0.asn1
```

- Modify the differences in the OSC source file one by one. The following is to directly use the OSC original file to modify the file â†’ Compilation fails

```bash
 D l2/src/codec_utils/RRC/FailureInfoRLC-Bearer.c
 D l2/src/codec_utils/RRC/FailureInfoRLC-Bearer.h
 D l2/src/codec_utils/RRC/FailureInformation-IEs.c
 D l2/src/codec_utils/RRC/FailureInformation-IEs.h
 D l2/src/codec_utils/RRC/FailureInformation.c
 D l2/src/codec_utils/RRC/FailureInformation.h
 D l2/src/codec_utils/RRC/Makefile.am.asn1convert
 D l2/src/codec_utils/RRC/OverheatingAssistance.c
 D l2/src/codec_utils/RRC/OverheatingAssistance.h
 D l2/src/codec_utils/RRC/RRCRelease-v1540-IEs.c
 D l2/src/codec_utils/RRC/RRCRelease-v1540-IEs.h
 D l2/src/codec_utils/RRC/ReducedAggregatedBandwidth.c
 D l2/src/codec_utils/RRC/ReducedAggregatedBandwidth.h
 D l2/src/codec_utils/RRC/UEAssistanceInformation-IEs.c
 D l2/src/codec_utils/RRC/UEAssistanceInformation-IEs.h
 D l2/src/codec_utils/RRC/UEAssistanceInformation-v1540-IEs.c
 D l2/src/codec_utils/RRC/UEAssistanceInformation-v1540-IEs.h
 D l2/src/codec_utils/RRC/pdu_collection.c
```

- Rebuild ANS1 file for RRC

```bash
cd /opt/asn1c/bin
sudo rm -r /home/hpe/o-du-l2/src/codec_utils/RRC
sudo ./asn1c -pdu=all -fcompound-names -gen-UPER -no-gen-BER -no-gen-JER -no-gen-OER -gen-APER -no-gen-example -findirect-choice -D ./temp /home/hpe/NTUST-script/CONFIG/rrc_15_3.asn1
mkdir /home/hpe/o-du-l2/src/codec_utils/RRC
sudo mv ./temp/* /home/hpe/o-du-l2/src/codec_utils/RRC

####### one-line command
cd /opt/asn1c/bin && sudo rm -r /home/hpe/o-du-l2/src/codec_utils/RRC && sudo ./asn1c -pdu=all -fcompound-names -gen-UPER -no-gen-BER -no-gen-JER -no-gen-OER -gen-APER -no-gen-example -findirect-choice -D ./temp /home/hpe/NTUST-script/CONFIG/rrc_15_3.asn1 && mkdir /home/hpe/o-du-l2/src/codec_utils/RRC && sudo mv ./temp/* /home/hpe/o-du-l2/src/codec_utils/RRC

####### Build from OAI defintion files
cd /opt/asn1c/bin && sudo ./asn1c -pdu=all -fcompound-names -gen-UPER -no-gen-BER -no-gen-JER -no-gen-OER -gen-APER -no-gen-example -findirect-choice -D ./temp /home/hpe/openairinterface5g/openair2/RRC/NR/MESSAGES/ASN.1/nr-rrc-17.3.0.asn1 && mkdir /home/hpe/o-du-l2/src/codec_utils/Temp_RRC && sudo mv ./temp/* /home/hpe/o-du-l2/src/codec_utils/Temp_RRC && cd /home/hpe/o-du-l2/src/codec_utils/Temp_RRC 

####### Auto execut script
cd /opt/asn1c/bin && sudo ./asn1c -pdu=all -fcompound-names -gen-UPER -no-gen-BER -no-gen-JER -no-gen-OER -gen-APER -no-gen-example -findirect-choice -D ./temp /home/hpe/NTUST-script/CONFIG/rrc_15_3.asn1 && mkdir /home/hpe/o-du-l2/src/codec_utils/Temp_RRC && sudo mv ./temp/* /home/hpe/o-du-l2/src/codec_utils/Temp_RRC && cd /home/hpe/o-du-l2/src/codec_utils/ && sudo rm /home/hpe/o-du-l2/src/codec_utils/RRC/* && ./pick.sh && sudo rm -r /home/hpe/o-du-l2/src/codec_utils/Temp_RRC

```

- Ensure F1AP and E2AP folder is OSC original source code

```bash
git log -- /home/hpe/o-du-l2/src/codec_utils/F1AP
git restore --source=c07f2e2ea6dc72a400d16322e73780ad40e0ffb2 -- src/codec_utils/F1AP
git log -- /home/hpe/o-du-l2/src/codec_utils/E2AP
git restore --source=f6d2e6f0523c7686e6cd1a1b1c08fe2a9b2df683 -- src/codec_utils/E2AP
git log -- /home/hpe/o-du-l2/build/common
git restore --source=e79d1c63c1d86c0c479a584e03ca801106a1a5b2 -- build/common
git log -- /home/hpe/o-du-l2/src/du_app
git restore --source=9d13bb384381778749c0854fb9842c71355b328e -- src/du_app

```