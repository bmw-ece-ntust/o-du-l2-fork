# Responding to Robert: MIB Decoding Issue

Start Date: 2024/11/28
Summary: Addressing MIB decoding issues and integrating nFAPI while exploring solutions for incomplete cellGroupConfig data.
Status: Done
Assign: Ming ÂíöÂíö [ÈäòÈ¥ª]
Tags: mail
Finish Date: 2024/11/29
SUM: üóìÔ∏è Days Spent to Complete: 1

Title: Addressing MIB Decoding Issues and nFAPI Integration Challenges

## Robert's Questions (11:00 PM)

1. Status update request on nFAPI work implementation
2. Issue with MIB decoding on UE side

```diff
Hi Ming, what's the status of your nFAPI work? it works now?
I also have a question, we are now decoding MIB, but the UE does not decode properly. I think you told me what was the problem, do you still know it and if yes, could you please let me know the solution?
```

## Ming's Response (1:13 PM)

```diff
Hi
I‚Äôm currently integrating the feature but have run into the issue we discussed previously‚Äîreceiving an incomplete cellGroupConfig. I‚Äôve verified that a significant portion of data is lost before the DU sends it out and the UE receives it. Through unit testing, I‚Äôve identified the root cause as a bug in Nokia‚Äôs asn1c. Unfortunately, this means I‚Äôll have to wait for Nokia to fix it before proceeding further.
In the meantime, I‚Äôve been exploring OAI‚Äôs implementation of a fully scripted asn1c workflow using CMake. One file that caught my attention is openairinterface5g/openair2/RRC/NR/MESSAGES/ASN.1/nr-rrc-17.3.0.cmake. It seems to describe the filenames generated after asn1c compilation. Since I‚Äôm not very familiar with CMake, could you advise whether this file is usually written manually or automatically generated by a script?
Regarding the MIB, when I previously traced the code, I found that OSC and OAI handle the SFN information in the MIB payload quite differently. After reviewing both implementations and cross-referencing the spec, I decided to adopt OAI's approach and made adjustments to the OSC implementation. With this, I was able to successfully decode the PBCCH on the UE side.
I‚Äôm not sure if you‚Äôre encountering a similar issue, but I‚Äôve prepared a patch for reference in case it helps.
My diagram might be a bit messy, but I want to clarify: the green sections represent the final transmitted SFN fragments, while the red boxes highlight the systemFrameNumber structure within the MIB, which is 6 bits in total.
```

Current Status:

- Feature integration in progress
- Encountered issue with incomplete `cellGroupConfig`:
    - Data loss identified between DU transmission and UE reception
    - Root cause: Bug in Nokia's `asn1c`
    - Waiting for Nokia's fix to proceed

Current Investigation:

- Exploring OAI's `asn1c` workflow using CMake
    - Examining file: `openairinterface5g/openair2/RRC/NR/MESSAGES/ASN.1/nr-rrc-17.3.0.cmake`
    - Question about file generation: manual vs automated

MIB Issue Resolution:

- Identified difference in SFN handling between OSC and OAI
- Adopted OAI's approach after spec verification
- Successfully implemented PBCCH decoding on UE side
- Patch available for reference

Technical Details:

- Green sections: Final transmitted SFN fragments
- Red boxes: `systemFrameNumber` structure (6 bits total)

[MIB.patch](MIB.patch)

![image.png](image%2097.png)

## Robert's Response (4:22 PM)

Thanks Ming, this is helpful. I've forwarded your MIB-related information to our OSC collaborators.

Regarding the CellGroupConfig issue, we'll address it with the OAI team once their UE successfully decodes the MIB.

```bash
thanks Ming, helpful, I forwarded your MIB stuff to some OSC people we are working with, I hope it is fine
ok for the CellGroupConfig, once OAI UE decodes MIB, we will see with them for the CellGroupConfig

regarding this:
In the meantime, I‚Äôve been exploring OAI‚Äôs implementation of a fully scripted asn1c workflow using CMake. One file that caught my attention is openairinterface5g/openair2/RRC/NR/MESSAGES/ASN.1/nr-rrc-17.3.0.cmake. It seems to describe the filenames generated after asn1c compilation. Since I‚Äôm not very familiar with CMake, could you advise whether this file is usually written manually or automatically generated by a script?
yes, the .cmake file describes which .asn file is the base grammar, and which files this grammar produces (headers and source files). This is necessary for cmake to be able to build in parallel asn1 (and we have many: S1AP, NGAP, F1AP, E1AP, X2AP, XnAP, M2AP, M3AP, LTE RRC, NR RRC, NRPPA, LPP) by instructing ninja/make to do the generation of sources and build, but in order to do so, cmake needs to know what will come out of these files. Previously, it was cmake itself that was running asn1c, but it can only do so serially, which takes veeeeeery long as opposed to running these things in parallel.
The file is written manually, but it's simple:
I prepare the bare .asn1 file where I have set(grammar <file>) set(source ...) set (header ...)
I ran asn1c manually and wait that it produces all files in a subdirectory
I include the generated file names in the .asn1 file. In vim that is easy, you can just do :read ls <dir>/*.h and you get all headers in the current file from within <dir>
then I rearrange and it is done
it could maybe be done with a script, but that would be more time. Instead of doing the vim trick, you could also simply do in bash:
ls <dir>/*.h >> openair2/RRC/NR/MESSAGES/ASN.1/nr-rrc-17.3.0.cmake
and then rearrange

maybe i should write this down
```

### About the .cmake File Generation

The `.cmake` file serves as a configuration file that specifies:

- The base grammar `.asn` file
- Generated output files (headers and source files)

This configuration enables parallel building of multiple ASN.1 components including:

- Protocol implementations:
    - S1AP, NGAP, F1AP, E1AP
    - X2AP, XnAP, M2AP, M3AP
    - LTE RRC, NR RRC
    - NRPPA, LPP

The file creation process is manual but straightforward:

1. Create initial `.asn1` file with basic settings:
`set(grammar <file>)
set(source ...)
set(header ...)`
2. Run `asn1c` to generate files in a subdirectory
3. Add generated filenames using either:
    - Vim command: `:read ls <dir>/*.h`
    - Bash command: `ls <dir>/*.h >> nr-rrc-17.3.0.cmake`
4. Rearrange the content as needed