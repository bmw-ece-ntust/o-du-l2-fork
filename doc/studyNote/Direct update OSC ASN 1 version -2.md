# Direct update OSC ASN.1 version -2

Start Date: 2024/06/26
Summary: Resolved naming conflicts in OSC's ASN.1 compilation process to successfully encode and decode SIB1 parameters while addressing ongoing issues with PLMN encoding.
Status: Done
Assign: Ming 咚咚 [銘鴻]

<aside>
💡 
After regenerating the SIB1-related ASN.1 files, I encountered issues when directly compiling the OSC C code, as it resulted in failures. By examining the compiler error log, I discovered that OSC’s F1AP and E2AP folders had naming conflicts. OSC’s source code in the `codec_utils` directory contains three main folders: RRC, F1AP, and E2AP. The OSC code often uses structs from the RRC folder but modifies their naming conventions by adding an RRC suffix. However, the regenerated SIB1 structs do not have these suffixes, causing conflicts with the F1AP and E2AP folders during compilation. Since the files generated by the compiler are read-only, I had to manually adjust the naming conventions in the E2AP and F1AP folders. For example, I changed file names from `PagingRrc` to `PagingE2AP` and `PagingF1AP` to resolve these conflicts and ensure that the OSC C code compiler could build successfully.

</aside>

<aside>
💡 Regarding this solution, I have some additional thoughts. I also modified the makefile, but I'm not sure if adjusting the makefile could prevent the C code compiler errors caused by naming conflicts. I believe it’s worth a try because it could significantly reduce the amount of modification needed for OSC. However, I’ve just resolved the issue with decoding MSG2 and am currently addressing the MSG3 problem. I hope to proceed smoothly with MSG4 and then revisit testing these ideas, since the current solution is working.

</aside>

Use nr-rrc-17.3.0.asn1 to build c files and head files

[nr-rrc-17.3.0.asn1](nr-rrc-17.3.0%201.asn1)

Try to fix all of OSC complier build err log…

- Creat and modify OSC make file, link all of indeed files
- incorrect asn1 build c file or head file name → modify OSC source code (#include name)
- 

- Result

```
-e Compiling [31m[1m /home/hpe/mwnl-odu-at-oai-based-on-scf/l2/src/mt/ss_timer.c [m
/home/hpe/mwnl-odu-at-oai-based-on-scf/l2/src/mt/ss_msg.c: In function ‘SPrntMsg’:
/home/hpe/mwnl-odu-at-oai-based-on-scf/l2/src/mt/ss_msg.c:5395:9: warning: variable ‘reg’ set but not used [-Wunused-but-set-variable]
 5395 |    Data reg =0;
      |         ^~~
make[1]: Leaving directory '/home/hpe/mwnl-odu-at-oai-based-on-scf/l2/build/odu'
make[1]: Entering directory '/home/hpe/mwnl-odu-at-oai-based-on-scf/l2/build/odu'
-e Compiling [31m[1m /home/hpe/mwnl-odu-at-oai-based-on-scf/l2/src/phy_stub//phy_stub_ex_ms.c [m
-e Compiling [31m[1m /home/hpe/mwnl-odu-at-oai-based-on-scf/l2/src/phy_stub//phy_stub_msg_hdl.c [m
-e Compiling [31m[1m /home/hpe/mwnl-odu-at-oai-based-on-scf/l2/src/phy_stub//phy_stub_thread_hdl.c [m
-e Creating Archive [31m[1m /home/hpe/mwnl-odu-at-oai-based-on-scf/l2/build/odu/lib/odu/libphystub.a [m
make[1]: Leaving directory '/home/hpe/mwnl-odu-at-oai-based-on-scf/l2/build/odu'
-e ***** BUILD COMPLETE *****
```

[**[Match SIB1] Add searchSpaceType (based on the comparison with OAI SIB1)**](https://github.com/dong881/NTUST-OSC-DU-nFAPI/commit/45539ae5324a7aff42994582e26fe6da5568723f)

[**[Match SIB1] Upgrade ASN.1 RRC version 15_3->17.3.0 (and change Folder name)**](https://github.com/dong881/NTUST-OSC-DU-nFAPI/commit/9a1c5f5fe6cf494887b86b79fe7b59d75eb28f34)

[**[Match SIB1] Because of the version update, a substantial modification of the original makefile and OSC source code's variable names is required to ensure successful compilation.**](https://github.com/dong881/NTUST-OSC-DU-nFAPI/commit/291f349eb0b08324c0196d9ac77e4162b5d1a2e7)

## Issues: PLMN cannot encode

- Follow OAI allocate method and use ASN.1 source function → `ASN_SEQUENCE_ADD`

```cpp
/*
 * SEQUENCE OF is the same as SET OF with a tiny difference:
 * the delete operation preserves the initial order of elements
 * and thus MAY operate in non-constant time.
 */
#define	A_SEQUENCE_OF(type)	A_SET_OF(type)

#define	ASN_SEQUENCE_ADD(headptr, ptr)		\
	asn_sequence_add((headptr), (ptr))

```

- 重新確認位址分配情況
- 確認ASN.1

## Solution: Modify OSC DU source code

由於透過OAI的ASN.1 struct.ans1 file 重新編譯ASN.1 c file and head file struct，因此和OSC原生source code所定義的struct name有落差，因此我決定手動修改match struct name，根據compile error log一步一步找出位定義的struct name，並根據新舊版差異比對找出新版本名稱替換上去，最終，順利compile成功。

但是衍生出的問題是PLMN無法decode，目前仍在研究，並且懷疑：

- E2AP資料夾
- F1AP資料夾

最終，經測試發現有重複宣告同檔案名稱的head file因此優先使用了E2AP與F1AP資料夾，但這兩個資料夾尚未升級，因此結構缺乏完整性造成encode失敗，修改命名方式後即可順利encode and decode SIB1 ASN.1!

→ 衍生問題：經修改目前無法encode MIB，目前仍在研究並且懷疑：

- 因更新結構造成無法encode，僅需做相同方式檢查，應能盡快找出原因

根據之前比對的SIB1 所有參數紀錄，將之前為了單一測試找出問題所revert掉的commit逐一測試補回來，即可解開SIB1

→ 目前無法送出MSG1 

成功參考Robert提供的OAI ASN.1相關內容將OSC 的版本從rel.15更新到rel.17
目前可以成功encode/decode SIB1的searchspace Type這個參數了
也就是已經解決之前信中提到的問題
想請教教授我應該向他們回報解決方案嗎？

問題描述：
SIB1 在做 ASN.1 encode時會根據 由 ASN1compiler  將 ASN.1 描述檔 編譯成 .c .h file的結構(struct) 做encode
而ASN1compiler 有許多開源版本，舉例OSC 和 OAI就使用不同來源，差異點在於支援度多寡 (UPER、PER等等類型)
且ASN.1 描述檔是根據3GPP定義 有版本問題 rel.15, rel.16, rel.17 因此不同版本所編譯出來的結構也不同
SIB1在Layer2 encode之前，需要根據這些struct 名稱分配記憶體位址與值，最終才能順利encode

解決步驟：

- 使用OAI正在使用的ASN1compiler 以及ASN.1 描述檔(rel.17)，重新再OSC資料夾內編譯
- 版本更新後結構體命名差很多，因此我根據compile OSC error log逐一調整OSC source code有填入資料的部分，修改更新變數名稱
- 最後調整SIB1 參數 參考OAI L2 + L1 的設定

目前整合狀況是可以成功傳送
下行：MIB、DCI、SIB1
上行：RA (只有看到UE送到OAI PNF，並未送到OSC DU High)

但是根據OAI L2 + L1的範例來分析，OAI PNF是要可以順利傳送的，因此下一步我會繼續檢查是甚麼原因造成